# Handle preflight OPTIONS requests will be handled in individual location blocks

# Health check endpoint
location /health {
    return 200 '{"status": "healthy", "service": "nginx-gateway"}';
    add_header Content-Type application/json;
}

# Documentation routes - must be defined BEFORE the general service routes
location = /users/docs {
    proxy_pass http://user-service/docs;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location = /orders/docs {
    proxy_pass http://order-service/docs;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Rewrite OpenAPI URL for order service
    sub_filter '"url": "/openapi.json"' '"url": "/orders/openapi.json"';
    sub_filter '"url":"/openapi.json"' '"url":"/orders/openapi.json"';
    sub_filter '"/openapi.json"' '"/orders/openapi.json"';
    sub_filter_once off;
    sub_filter_types text/html application/javascript text/css;
}

location = /payments/docs {
    proxy_pass http://payment-service/docs;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Rewrite OpenAPI URL for payment service
    sub_filter '"url": "/openapi.json"' '"url": "/payments/openapi.json"';
    sub_filter '"url":"/openapi.json"' '"url":"/payments/openapi.json"';
    sub_filter '"/openapi.json"' '"/payments/openapi.json"';
    sub_filter_once off;
    sub_filter_types text/html application/javascript text/css;
}


# OpenAPI JSON endpoints for documentation
location = /users/openapi.json {
    proxy_pass http://user-service/openapi.json;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location = /orders/openapi.json {
    proxy_pass http://order-service/openapi.json;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location = /payments/openapi.json {
    proxy_pass http://payment-service/openapi.json;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# User Service routes - handle all /users paths (docs handled by exact match above)
location ~ ^/users(/.*)?$ {
    limit_req zone=api burst=20 nodelay;
    proxy_pass http://user-service/users$1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}

# Order Service routes - handle all /orders paths (docs handled by exact match above)
location ~ ^/orders(/.*)?$ {
    limit_req zone=api burst=20 nodelay;
    proxy_pass http://order-service/orders$1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}

# Payment Service routes - handle all /payments paths (docs handled by exact match above)
location ~ ^/payments(/.*)?$ {
    limit_req zone=api burst=20 nodelay;
    proxy_pass http://payment-service/payments$1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}

# API Documentation routes
location /docs {
    return 301 /users/docs;
}

location /user-docs {
    proxy_pass http://user-service/docs;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# OpenAPI JSON files for documentation
location = /openapi.json {
    proxy_pass http://user-service/openapi.json;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location /order-docs {
    proxy_pass http://order-service/docs;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Custom OpenAPI URL for order service docs
    sub_filter '"url":"/openapi.json"' '"url":"/order-openapi.json"';
    sub_filter_once off;
    sub_filter_types application/json text/html;
}

location /order-openapi.json {
    proxy_pass http://order-service/openapi.json;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location /payment-docs {
    proxy_pass http://payment-service/docs;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Custom OpenAPI URL for payment service docs
    sub_filter '"url":"/openapi.json"' '"url":"/payment-openapi.json"';
    sub_filter_once off;
    sub_filter_types application/json text/html;
}

location /payment-openapi.json {
    proxy_pass http://payment-service/openapi.json;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}


# Metrics endpoints (protected)
location /metrics {
    deny all;
    return 403 '{"error": "Forbidden", "message": "Metrics access denied"}';
    add_header Content-Type application/json;
}

# Catch-all route - API information (must be last)
location = / {
    return 200 '{"message": "FastAPI Microservices Gateway", "services": {"users": "/users", "orders": "/orders", "payments": "/payments"}, "docs": {"users": "/user-docs", "orders": "/order-docs", "payments": "/payment-docs"}}';
    add_header Content-Type application/json;
}

# Error pages
error_page 404 /404.json;
error_page 500 502 503 504 /50x.json;

location = /404.json {
    return 404 '{"error": "Not Found", "message": "The requested resource was not found"}';
    add_header Content-Type application/json;
}

location = /50x.json {
    return 500 '{"error": "Internal Server Error", "message": "Something went wrong"}';
    add_header Content-Type application/json;
}
